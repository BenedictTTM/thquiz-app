name: Load Testing - Product API

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GitHub Actions Workflow for Automated Load Testing
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# This workflow runs k6 load tests automatically on:
# - Pull requests to main branch
# - Scheduled daily tests
# - Manual workflow dispatch
#
# Follows enterprise best practices:
# - Runs smoke tests on every PR
# - Runs comprehensive tests daily
# - Fails PR if performance thresholds not met
# - Stores test results as artifacts
# - Comments results on PR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  # Run on pull requests to main
  pull_request:
    branches:
      - main
    paths:
      - 'Backend/src/product/**'
      - 'Backend/k6-tests/**'
      - 'Backend/prisma/schema.prisma'

  # Daily scheduled tests
  schedule:
    - cron: '0 2 * * *' # 2 AM UTC daily

  # Manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - spike

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SMOKE TEST - Quick validation on every PR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  smoke-test:
    name: Smoke Test (PR Validation)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json

      - name: Install k6
        run: |
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Verify k6 installation
        run: k6 version

      - name: Install dependencies
        working-directory: Backend
        run: npm ci

      - name: Setup test database
        working-directory: Backend
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
        run: |
          npx prisma generate
          npx prisma db push

      - name: Start backend server
        working-directory: Backend
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NODE_ENV: test
        run: |
          npm run build
          npm run start:prod &
          echo $! > server.pid

          # Wait for server to be ready (max 30 seconds)
          for i in {1..30}; do
            if curl -s http://localhost:3001/products?limit=1 > /dev/null; then
              echo "Server is ready!"
              break
            fi
            echo "Waiting for server... ($i/30)"
            sleep 1
          done

      - name: Run Smoke Test
        working-directory: Backend
        run: |
          k6 run \
            --env TEST_TYPE=smoke \
            --env BASE_URL=http://localhost:3001 \
            --out json=k6-reports/smoke-results.json \
            k6-tests/product-api-load-tests.js

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: Backend/k6-reports/
          retention-days: 30

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('Backend/k6-reports/smoke-results.json', 'utf8'));

            // Parse results and create comment
            const comment = `## ğŸ§ª Load Test Results (Smoke Test)

            | Metric | Value | Status |
            |--------|-------|--------|
            | Test Duration | ${results.state.testRunDurationMs}ms | âœ… |
            | Total Requests | ${results.metrics.http_reqs?.values?.count || 0} | âœ… |
            | Error Rate | ${(results.metrics.http_req_failed?.values?.rate * 100).toFixed(2)}% | ${results.metrics.http_req_failed?.values?.rate < 0.01 ? 'âœ…' : 'âŒ'} |
            | Avg Response Time | ${results.metrics.http_req_duration?.values?.avg.toFixed(2)}ms | ${results.metrics.http_req_duration?.values?.avg < 200 ? 'âœ…' : 'âš ï¸'} |
            | p95 Response Time | ${results.metrics.http_req_duration?.values?.['p(95)'].toFixed(2)}ms | ${results.metrics.http_req_duration?.values?.['p(95)'] < 200 ? 'âœ…' : 'âš ï¸'} |

            ${results.metrics.http_req_failed?.values?.rate < 0.01 && results.metrics.http_req_duration?.values?.['p(95)'] < 200 
              ? 'âœ… **All performance checks passed!**' 
              : 'âš ï¸ **Performance issues detected. Please review.**'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Cleanup
        if: always()
        working-directory: Backend
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # COMPREHENSIVE TEST - Daily scheduled tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  comprehensive-test:
    name: Comprehensive Load Test (Scheduled)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        test-type:
          - smoke
          - load
          - stress

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install k6
        run: |
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run ${{ matrix.test-type }} Test against Staging
        working-directory: Backend
        env:
          BASE_URL: ${{ secrets.STAGING_API_URL }}
        run: |
          k6 run \
            --env TEST_TYPE=${{ matrix.test-type }} \
            --env BASE_URL=${{ env.BASE_URL }} \
            --out json=k6-reports/${{ matrix.test-type }}-results.json \
            k6-tests/product-api-load-tests.js

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.test-type }}-test-results
          path: Backend/k6-reports/
          retention-days: 90

      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ Load Test Failed: ${{ matrix.test-type }} test on ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Load Test Failure*\n\n*Test Type:* ${{ matrix.test-type }}\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref }}\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PERFORMANCE REGRESSION CHECK
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  regression-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: smoke-test

    steps:
      - name: Download current test results
        uses: actions/download-artifact@v4
        with:
          name: smoke-test-results
          path: current/

      - name: Download baseline results
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          workflow: load-testing.yml
          branch: main
          name: smoke-test-results
          path: baseline/

      - name: Compare performance
        run: |
          if [ -f baseline/smoke-results.json ] && [ -f current/smoke-results.json ]; then
            # Simple comparison script
            echo "Comparing performance metrics..."
            
            # Extract p95 from both files
            BASELINE_P95=$(cat baseline/smoke-results.json | jq '.metrics.http_req_duration.values["p(95)"]')
            CURRENT_P95=$(cat current/smoke-results.json | jq '.metrics.http_req_duration.values["p(95)"]')
            
            # Calculate percentage difference
            DIFF=$(echo "scale=2; ($CURRENT_P95 - $BASELINE_P95) / $BASELINE_P95 * 100" | bc)
            
            echo "Baseline p95: ${BASELINE_P95}ms"
            echo "Current p95: ${CURRENT_P95}ms"
            echo "Difference: ${DIFF}%"
            
            # Fail if performance degraded by more than 20%
            if (( $(echo "$DIFF > 20" | bc -l) )); then
              echo "âŒ Performance regression detected: ${DIFF}% slower than baseline"
              exit 1
            else
              echo "âœ… No significant performance regression"
            fi
          else
            echo "âš ï¸ No baseline found, skipping comparison"
          fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ADDITIONAL WORKFLOW CONFIGURATIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: load-test-${{ github.ref }}
  cancel-in-progress: true
