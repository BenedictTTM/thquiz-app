generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   Int         @id @default(autoincrement())
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  email                String      @unique
  passwordHash         String
  username             String      @unique
  phone                String?     @unique
  schoolId             String?
  schoolIdPic          String?
  profilePic           String?
  firstName            String?
  lastName             String?
  premiumTier          PremiumTier @default(FREE)
  availableSlots       Int         @default(5)
  usedSlots            Int         @default(0)
  premiumExpiry        DateTime?
  role                 Role        @default(USER)
  isDeleted            Boolean     @default(false)
  rating               Float       @default(0.0)
  totalRatings         Int         @default(0)
  passwordResetExpires DateTime?
  passwordResetToken   String?
  refreshToken         String?
  refreshTokenExp      DateTime?
  storeName            String?
  cart                 Cart?
  receivedMessages     Message[]   @relation("ReceivedMessages")
  sentMessages         Message[]   @relation("SentMessages")
  buyerOrders          Order[]     @relation("BuyerOrders")
  sellerOrders         Order[]     @relation("SellerOrders")
  payments             Payment[]
  products             Product[]
  reports              Report[]
  reviews              Review[]    @relation("ReviewerReviews")

  @@index([createdAt])
  @@index([premiumTier])
  @@index([role])
  @@index([availableSlots])
}

model Product {
  id               Int            @id @default(autoincrement())
  title            String
  description      String?
  imageUrl         String[]
  category         String
  originalPrice    Float
  discountedPrice  Float
  stock            Int
  isActive         Boolean        @default(true)
  isSold           Boolean        @default(false)
  condition        String
  tags             String[]
  views            Int            @default(0)
  locationLat      Float?
  locationLng      Float?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  averageRating    Float          @default(0.0)
  totalReviews     Int            @default(0)
  lastRatingUpdate DateTime?
  userId           Int
  cartItems        CartItem[]
  delivery         Delivery?
  orderItems       OrderItem[]
  user             User           @relation(fields: [userId], references: [id])
  images           ProductImage[]
  reports          Report[]
  reviews          Review[]

  // Performance indexes for high-traffic queries
  @@index([userId])
  @@index([averageRating])
  @@index([isActive])
  @@index([isSold])
  @@index([stock])
  @@index([discountedPrice])
  @@index([isActive, isSold])
  @@index([isActive, createdAt(sort: Desc)])
  @@index([category, isActive, isSold])
  @@index([category, createdAt(sort: Desc)])
  @@index([category, discountedPrice])
  @@index([category, views(sort: Desc)])
  @@index([category, averageRating(sort: Desc)])
  @@index([userId, isActive])
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  url       String
  productId Int
  product   Product @relation(fields: [productId], references: [id])
}

model Payment {
  id                Int         @id @default(autoincrement())
  amount            Float
  currency          String      @default("GHS")
  status            String      @default("PENDING")
  transactionId     String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  premiumTier       PremiumTier
  slotsGranted      Int
  validityMonths    Int
  paymentType       String      @default("PREMIUM")
  userId            Int
  metadata          Json?
  providerPaymentId String?     @unique
  user              User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Message {
  id         Int      @id @default(autoincrement())
  content    String
  sentAt     DateTime @default(now())
  senderId   Int
  receiverId Int
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
}

model Review {
  id         Int      @id @default(autoincrement())
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  reviewerId Int
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])
  reviewer   User     @relation("ReviewerReviews", fields: [reviewerId], references: [id])
}

model Delivery {
  id        Int     @id @default(autoincrement())
  method    String
  location  String?
  fee       Float?
  productId Int     @unique
  product   Product @relation(fields: [productId], references: [id])
}

model Report {
  id        Int      @id @default(autoincrement())
  reason    String
  createdAt DateTime @default(now())
  userId    Int
  productId Int?
  product   Product? @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@index([userId])
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cartId    Int
  productId Int
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
}

model Order {
  id             Int         @id @default(autoincrement())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  buyerId        Int
  sellerId       Int
  whatsappNumber String?
  callNumber     String?
  hall           String?
  buyerMessage   String?
  status         OrderStatus @default(PENDING)
  currency       String      @default("GHS")
  totalAmount    Float
  buyer          User        @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller         User        @relation("SellerOrders", fields: [sellerId], references: [id])
  items          OrderItem[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          Int     @id @default(autoincrement())
  orderId     Int
  productId   Int
  quantity    Int     @default(1)
  unitPrice   Float
  productName String?
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product @relation(fields: [productId], references: [id])

  @@unique([orderId, productId])
  @@index([productId])
}

enum PremiumTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

enum OrderStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}
